# ============================================================================
# Feature Branch CI - Fast Feedback Loop
# ============================================================================
# Runs on every push to feature/* and hotfix/* branches
# Provides quick feedback before PR is opened
# ============================================================================

name: Feature Branch CI

on:
  push:
    branches:
      - 'feature/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/CODEOWNERS'

env:
  CI: true
  NODE_ENV: test

jobs:
  # --------------------------------------------------------------------------
  # Quick Checks - Run in parallel for fast feedback
  # --------------------------------------------------------------------------
  
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Run linter
        run: npm run lint --if-present

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Run type check
        run: npm run type-check --if-present

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline
        
      - name: Run unit tests
        run: npm test --if-present

  # --------------------------------------------------------------------------
  # Security Scan - Critical for catching secrets and vulnerabilities
  # --------------------------------------------------------------------------
  
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Gitleaks (Secret Detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  # --------------------------------------------------------------------------
  # Summary Job - Provides overall status
  # --------------------------------------------------------------------------
  
  feature-branch-status:
    name: Feature Branch Status
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-tests, security-scan]
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.type-check.result }}" == "failure" ]] || \
             [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "::error::One or more checks failed"
            exit 1
          fi
          echo "::notice::All feature branch checks passed!"
